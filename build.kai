# DEFAULTS
# ========

default static

# VARIABLES
# =========

PUBLIC = /home/fel/var/public

# RULES
# =====

rule gemfmt: awk -f bin/unwrap.awk $in > $out
rule copy: cp -f $in $out
rule run: sh $in > $out

rule md2gmi: 
	command = [[
		sed -f bin/gemini/replace.sed $in
		| lowdown 
			-T gemini
			-M protocol:gemini
			-M extension:gmi
			--gemini-metadata
		> $out
	]]

rule md2html
	description = convert $in > $out
	command = [[
		:> $out;

		tr -d '\n\t' < etc/html/head.html >> $out;
		
		sh bin/html/header.sh $in >> $out;

		printf '<article>' >> $out;
		sed -f bin/html/replace.sed $in
		| lowdown 
			-T html
			-M protocol:https
			-M extension:html
			--parse-math
		>> $out;
		printf '</article>' >> $out;

		tr -d '\n\t' < etc/html/foot.html >> $out;
	]]

# VIRTUAL
# =======

rule push: rsync -rv --delete out/* $PUBLIC/www
build push: push

rule serve: sh bin/serve.sh
build serve: serve

default cgit
build cgit: phony out/html/cgi-bin/cgit out/html/css/cgit.css
build out/html/cgi-bin/cgit: copy /usr/share/webapps/cgit/cgit
build out/html/css/cgit.css: copy /usr/share/webapps/cgit/cgit.css

# TARGETS
# =======

# static
$[[ sh bin/target.sh ]]
